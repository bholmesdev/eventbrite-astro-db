---
import { Event, Ticket, db, eq } from "astro:db";
import Layout from "../../layouts/Layout.astro";
import Form from "../../components/form/Form.astro";
import Input from "../../components/form/Input.astro";
import { ticketForm } from "../../components/form/validators";

if (!Astro.params.event) return Astro.redirect("/404");

const event = await db
  .select()
  .from(Event)
  .where(eq(Event.id, Astro.params.event))
  .get();

if (!event) return Astro.redirect("/404");

const res = await Astro.locals.form.getData(ticketForm);

if (res?.data) {
  await db.insert(Ticket).values({
    eventId: Astro.params.event,
    email: res.data.email,
    quantity: res.data.quantity,
    newsletter: res.data.newsletter,
  });
}

const ticket = await db
  .select()
  .from(Ticket)
  .where(eq(Ticket.eventId, Astro.params.event))
  .get();
---

<Layout title="Welcome to Astro.">
  <main>
    <h1>{event.name}</h1>
    <p>
      {event.description}
    </p>

    <Form name="ticketForm">
      <label for="email">Email</label>
      <Input id="email" {...ticketForm.inputProps.email} />

      <label for="quantity">Quantity</label>
      <Input id="quantity" {...ticketForm.inputProps.quantity} />

      <label for="newsletter">Subscribe to newsletter</label>
      <Input id="newsletter" {...ticketForm.inputProps.newsletter} />

      <button type="submit">Buy tickets</button>
    </Form>
    {
      ticket && (
        <section class="youre-going">
          <h2>You're going ðŸ™Œ</h2>
          <p>
            You have purchased {ticket.quantity} tickets for {event.name}!
          </p>
          <p>
            Check <strong>{ticket.email}</strong> for your tickets.
          </p>
        </section>
      )
    }
  </main>
</Layout>
